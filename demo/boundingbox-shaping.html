<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Shapes Canvas</title>

    <link href="../css/shapesJS.css" rel="stylesheet" type="text/css"/>
    <script src="../libs/d3/d3.min.js"></script>
</head>

<body>

<div id="circle-container">
    <button id='rectangle'>Rectangle</button>
    <button id='circle'>Circle</button>
    <svg id="shape-svg" width="600" height="600"></svg>
</div>

<script>

    var svgCanvas = d3.select("#shape-svg");
//    var circle;
//    var point1 = [];
//    var point2 = [];
//    var rectData = [];
//    var gData = {};
//    var rect = {};
//    var gContainer;

    d3.select('#rectangle').on('click', function(){ new Rectangle(); } );

    d3.select('#circle').on('click', function(){ new Circle(); } );

function Rectangle(){

    var rectData = []; //holds the diagonal point 1 and 2 coordinates of the rectangle
    var rectContainer; // g element
    var shape = {}; //will hold the rectangle's d3 selections
    var start; //starting point
    var edge; //ending point
    var gData = {}; //holds translate values for g element

    var rectangleDrag =  svgCanvas.call(d3.drag().on("start", initialPlod)
        .on('drag', secondaryPlod)
        .on('end', onStopDraw));

    //start rendering on drag start
    function initialPlod(){
        start = d3.mouse(this);
//      console.log(start);
        rectData = [{x:start[0], y:start[1]}, {x:start[0], y:start[1]}];
        rectContainer = svgCanvas.append("g");
        shape.rectEl = rectContainer.append('rect').attr('class', 'rectangle');
        renderRectangle();
    }

    //when continuing to drag from point 2
    function secondaryPlod(){
        edge = d3.mouse(this);
        rectData[1] = {x: edge[0], y: edge[1]};
        renderRectangle();
    }

    //on stop drawing bind a drag event
    function onStopDraw(){

        svgCanvas.call(d3.drag().on("start", null)
            .on('drag', null)
            .on('end', null));

        var bbox = this.getBBox();
        console.log(bbox);

        //temporary variables that hold original position
        var rectCords = {
            x: bbox.x,
            y: bbox.y
        };

        //setting boundingbox to 0,0 coordinates
        bbox.x = 0;
        bbox.y = 0;

//      console.log(bbox);

        shape.rectEl.attr("x", bbox.x).attr("y", bbox.y);

        gData.x = rectCords.x;
        gData.y = rectCords.y;

        rectContainer.attr("transform", "translate(" + gData.x + "," + gData.y + ")");

        shape.rectEl.call(d3.drag().on("drag", dragRect));
    }

    //grab and drag rectangle
    function dragRect() {
        var move = d3.event;
        rectContainer.attr("transform", "translate(" + (gData.x += move.dx)  + "," + (gData.y += move.dy) + ")");
    }

    /**
     *
     * Method takes the x,y coordinates from rectData object array
     * which contains coordinates of point1 and point2
     * and calculates the the height and width
     *
     */
    function renderRectangle(){
        //rectangle attributes
        var xCoord = rectData[1].x - rectData[0].x > 0 ? rectData[0].x :  rectData[1].x;
        var yCoord = rectData[1].y - rectData[0].y > 0 ? rectData[0].y :  rectData[1].y;
        var width = Math.abs(rectData[1].x - rectData[0].x);
        var height = Math.abs(rectData[1].y - rectData[0].y);

        //render rectangle
        shape.rectEl.attr("x",xCoord)
            .attr("y", yCoord)
            .attr("width",width)
            .attr("height",height);

//        //drag point 1 left-top
//        var point1 = d3.select(shape.pointEl1._groups[0][0]);
//        point1.attr('r', 4)
//            .attr('cx', rectData[0].x)
//            .attr('cy', rectData[0].y);
//
//
//        //drag point 2 right-bottom
//        var point2 = d3.select(shape.pointEl2._groups[0][0]);
//        point2.attr('r', 4)
//            .attr('cx', rectData[1].x)
//            .attr('cy', rectData[1].y);
//
//
//        //drag point 3 right-top
//        var point3 = d3.select(shape.pointEl3._groups[0][0]);
//        point3.attr('r', 4)
//            .attr('cx', rectData[1].x)
//            .attr('cy', rectData[0].y);
//
//
//
//        //drag point 4 left-bottom
//        var point4 = d3.select(shape.pointEl4._groups[0][0]);
//        point4.attr('r', 4)
//            .attr('cx', rectData[0].x)
//            .attr('cy', rectData[1].y);

    }

}

    /**
     *
     * //////////////  Circle Draw  \\\\\\\\\\\\\
     *
     */

function Circle(){

    var circle;
    var gData = {};
    var shape = {};
    var gContainer;
    var point1, point2;

    svgCanvas.call(d3.drag().on("start", initialPlod)
        .on("drag", dragDraw)
        .on("end", stopRendering));

    //On Drag Start - initial marking of the circle on the canvas without drag points
    function initialPlod(){
        point1 = d3.mouse(this);
        gContainer = svgCanvas.append("g");
        circle = gContainer.append("circle")
            .attr("cx", point1[0])
            .attr("cy", point1[1])
            .attr("r", 0);

//        console.log("x: " + point1[0]  + "y: " + point1[1] );

        shape.rectEl = gContainer.append('rect').attr('class', 'rectangle-bind');
        shape.pointEl1 = gContainer.append('circle').attr('class', 'pointC');
        shape.pointEl2 = gContainer.append('circle').attr('class', 'pointC');
        shape.pointEl3 = gContainer.append('circle').attr('class', 'pointC');
        shape.pointEl4 = gContainer.append('circle').attr('class', 'pointC');

        //midpoints
//        shape.midpoint1 = gContainer.append('circle').attr('class', 'pointC');
//        shape.midpoint2 = gContainer.append('circle').attr('class', 'pointC');
//        shape.midpoint3 = gContainer.append('circle').attr('class', 'pointC');
//        shape.midpoint4 = gContainer.append('circle').attr('class', 'pointC');

    }

    function getRadius(cX, cY, perimeterX, perimeterY){
        /**
         * using circle equation
         *
         * r2 = (x2 - x1)^2 + (y2 - y1)^2
         */
        return Math.sqrt(Math.pow((perimeterX - cX), 2) + Math.pow((perimeterY - cY),2));
    }

    //On Drag
    function dragDraw(){
        point2 = d3.mouse(this);
        circle = circle.attr("r", getRadius(point1[0], point1[1], point2[0], point2[1]));
    }

    //On drag Stop
    function stopRendering() {
        svgCanvas.call(d3.drag().on("start", null)
            .on("drag", null)
            .on("end", null));

        var bbox = this.getBBox();
        console.log(bbox);

        //temporary variables that hold original position
        var circleCords = {
            x: bbox.x,
            y: bbox.y
        };

        //setting the bounding box coordinates to 0 for translate purpose
        bbox.x = 0;
        bbox.y = 0;

        //render a bounding box for the circle at 0,0
        shape.rectEl.attr("x", bbox.x).attr("y", bbox.y).attr("height", bbox.height).attr("width", bbox.width);

        //setting drag points to the bounding box rectangle
        shape.pointEl1.attr("cx", bbox.x).attr("cy", bbox.y).attr("r", 4);
        shape.pointEl2.attr("cx", (bbox.x + bbox.width)).attr("cy",(bbox.y + bbox.height)).attr("r",4);
        shape.pointEl3.attr("cx",bbox.x + bbox.width).attr("cy", bbox.y).attr("r",4);
        shape.pointEl4.attr("cx",bbox.x).attr("cy", bbox.y + bbox.height).attr("r",4);

        //mid points
//        shape.midpoint1.attr("cx", (bbox.x + bbox.width)/2).attr("cy", bbox.y).attr("r", 4);
//        shape.midpoint2.attr("cx", (bbox.x + bbox.width)).attr("cy", (bbox.y + bbox.height)/2).attr("r", 4);
//        shape.midpoint3.attr("cx", (bbox.x + bbox.width)/2).attr("cy", (bbox.y + bbox.height)).attr("r", 4);
//        shape.midpoint4.attr("cx", (bbox.x)).attr("cy", (bbox.y + bbox.height)/2).attr("r", 4);

        //changing circle attributes
        var circleAttr = {};

        circleAttr.cx = bbox.x + (bbox.width/2);
        circleAttr.cy = bbox.y + (bbox.height/2);
        circleAttr.r =  bbox.width/2;

        circle.attr("cx",  circleAttr.cx).attr("cy", circleAttr.cy);

        //setting original x,y coords to an external object to be used on circleDrag()
        gData.x = circleCords.x;
        gData.y = circleCords.y;

        gContainer.attr("transform", "translate(" + circleCords.x + "," + circleCords.y + ")");

        gContainer.call(d3.drag().on("drag", circleDrag));
    }

    //drag circle
    function circleDrag(){
        var move = d3.event;
        gContainer.attr("transform", "translate(" + (gData.x += move.dx)  + "," + (gData.y += move.dy) + ")");
    }
}


</script>
</body>
</html>