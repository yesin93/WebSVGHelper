<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Polygon Draw</title>

    <link href="../css/shapesJS.css" rel="stylesheet" type="text/css"/>
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.0/d3.min.js"></script>-->
    <script src="../libs/d3/d3.min.js"></script>
</head>
<body>
<button id='poly'>Poly</button>
<!--<script src="../js/drawRect.js"></script>-->

<script>
    d3.select('#poly').on('click', function(){ new Polygon(); });

    var w = 600, h = 500;
    var svgCanvas = d3.select('body').append('svg').attr("width", w).attr("height", h);

    function Polygon(){

        var polyPoints = [];
        var gContainer = svgCanvas.append('g').classed("outline", true);
        var isDrawing = false;
        var linePoint1, linePoint2;
        var startPoint;


//        var polyDrag =  svgCanvas.call(d3.drag().on("start", initialPlod)
//                                                  .on('drag', secondaryPlod));

        var polyDraw = svgCanvas.on("mousedown", setPoints)
                                .on("mousemove", drawline)
                                .on("mouseup", decidePoly);

        //initial plod of the polygon point
        function setPoints(){

//            if(isDragging){
//                return;
//            }

            isDrawing = true;

            var plod = d3.mouse(this);
            linePoint1 = {x: plod[0], y: plod[1]};

            polyPoints.push(plod);

            var circlePoint = gContainer.append("circle")
                .attr("cx", linePoint1.x)
                .attr("cy", linePoint1.y)
                .attr("r", 4)
                .attr("start-point", true)
                .classed("handle", true)
                .style("cursor", "pointer");

            //checking undefined using keyword bad practice?
//            if(startPoint === undefined){
//                startPoint = polyPoints[0];
//                console.log(startPoint);
//                circlePoint.attr("start-point", "true");
//            }else{
//                circlePoint.attr("start-point", "false");
//            }

            if(d3.event.target.hasAttribute("handle")){
                completePolygon()
            }


        }
        
        function drawline() {
            if(isDrawing){
                linePoint2 = d3.mouse(this);
                gContainer.select('line').remove();
                gContainer.append('line')
                    .attr("x1", linePoint1.x)
                    .attr("y1", linePoint1.y)
                    .attr("x2", linePoint2[0] - 2) //arbitary value must be substracted due to circle cursor hover not working
                    .attr("y2", linePoint2[1] - 2); // arbitary values must be tested
            }
        }

        function decidePoly(){

            gContainer.select('line').remove();

            gContainer.select('polyline').remove();

            var polyline = gContainer.append('polyline').attr('points', polyPoints);

            gContainer.selectAll('circle').remove();

            for(var i = 0; i < polyPoints.length; i++) {
                var circlePoint = gContainer.append('circle')
                    .attr('cx', polyPoints[i][0])
                    .attr('cy', polyPoints[i][1])
                    .attr('r', 4)
                    .attr("handle", true)
                    .classed("handle", true);

            }

        }

        function completePolygon(){
            d3.select('g.outline').remove();

            var gPoly = svgCanvas.append('g')
                .classed("polygon", true);

                gPoly.append("polygon")
                .attr("points", polyPoints);

            for(var i = 0; i < polyPoints.length; i++ ){
                gPoly.append('circle')
                    .attr("cx", polyPoints[i][0])
                    .attr("cy", polyPoints[i][1])
                    .attr("r",  4)
                    .call(alterPolygon);
            }

            isDrawing = false;
        }

        function alterPolygon(){
            if(isDrawing === true)return;

            var circles = d3.select(this);
        }
    }

</script>
</body>
</html>