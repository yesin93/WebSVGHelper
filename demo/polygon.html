<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="UTF-8">
    <title>Polygon Draw</title>

    <link href="../css/shapesJS.css" rel="stylesheet" type="text/css"/>
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.0/d3.min.js"></script>-->
    <script src="../libs/d3/d3.min.js"></script>

</head>

<body>

<button id='poly'>Poly</button>

<script>
    d3.select('#poly').on('click', function(){ new Polygon(); });

    var w = 600, h = 500;
    var svgCanvas = d3.select('body').append('svg').attr("width", w).attr("height", h);

    function Polygon(){

        var polyPoints = [];
        var gContainer = svgCanvas.append('g').classed("outline", true);
        var isDrawing = false;
        var isDragging = false;
        var linePoint1, linePoint2;
        var startPoint;

        var polyDraw = svgCanvas.on("mousedown", setPoints)
                                .on("mousemove", drawline)
                                .on("mouseup", decidePoly);

        var dragBehavior = d3.drag().on("drag", alterPolygon);

        //On mousedown - setting points for the polygon
        function setPoints(){

            if(isDragging) return;


            isDrawing = true;

            var plod = d3.mouse(this);
            linePoint1 = {x: plod[0], y: plod[1]};

            polyPoints.push(plod);

            var circlePoint = gContainer.append("circle")
                .attr("cx", linePoint1.x)
                .attr("cy", linePoint1.y)
                .attr("r", 4)
                .attr("start-point", true)
                .classed("handle", true)
                .style("cursor", "pointer");

            //checking undefined using keyword bad practice?
//            if(startPoint === undefined){
//                startPoint = polyPoints[0];
//                console.log(startPoint);
//                circlePoint.attr("start-point", "true");
//            }else{
//                circlePoint.attr("start-point", "false");
//            }

            // on setting points if mousedown on a handle
            if(d3.event.target.hasAttribute("handle")){
                completePolygon()
            }

        }

        //on mousemove - appending SVG line elements to the points
        function drawline() {

            if(isDrawing){
                linePoint2 = d3.mouse(this);
                gContainer.select('line').remove();
                gContainer.append('line')
                    .attr("x1", linePoint1.x)
                    .attr("y1", linePoint1.y)
                    .attr("x2", linePoint2[0] - 2) //arbitary value must be substracted due to circle cursor hover not working
                    .attr("y2", linePoint2[1] - 2); // arbitary values must be tested

            }
        }

        //On mouseup - Removing the placeholder SVG lines and adding polyline
        function decidePoly(){

            gContainer.select('line').remove();
            gContainer.select('polyline').remove();

            var polyline = gContainer.append('polyline').attr('points', polyPoints);

            gContainer.selectAll('circle').remove();

            for(var i = 0; i < polyPoints.length; i++) {
                var circlePoint = gContainer.append('circle')
                    .attr('cx', polyPoints[i][0])
                    .attr('cy', polyPoints[i][1])
                    .attr('r', 4)
                    .attr("handle", true)
                    .classed("handle", true);

            }

        }

        //Called on mousedown if mousedown point if a polygon handle
        function completePolygon(){
            d3.select('g.outline').remove();

            var gPoly = svgCanvas.append('g')
                .classed("polygon", true);

            polyPoints.splice(polyPoints.length-1);
            console.log(polyPoints);

                gPoly.append("polygon")
                .attr("points", polyPoints);



            for(var i = 0; i < polyPoints.length; i++ ){
                gPoly.append('circle')
                    .attr("cx", polyPoints[i][0])
                    .attr("cy", polyPoints[i][1])
                    .attr("r",  4)
                    .call(dragBehavior);
            }

            isDrawing = false;
            isDragging = true;
        }

        //Altering polygon coordinates based on handle drag
        function alterPolygon(){

            if(isDrawing === true)return;

            var alteredPoints = [];
            var selectedP = d3.select(this);

            //go to selected
            var circles = d3.select(this.parentNode).selectAll('circle');
            var polygon = d3.select(this.parentNode).select('polygon');


            var pointCX = d3.event.x;
            var pointCY = d3.event.y;


            selectedP.attr("cx", pointCX).attr("cy", pointCY);

            //loop through the group of circles attatched to the polygon
            for(var i=0; i < polyPoints.length; i++){

                var circleCoord = d3.select(circles._groups[0][i]);
                var pointCoord = [ circleCoord.attr("cx"), circleCoord.attr("cy") ];
                alteredPoints[i] = pointCoord;

            }

            polygon.attr("points", alteredPoints);

        }
    }

</script>

</body>
</html>